daemon off;
#Heroku dynos have at least 4 cores.
worker_processes <%= ENV['NGINX_WORKERS'] || 4 %>;

events {
	use epoll;
	accept_mutex on;
	worker_connections 1024;
}

http {

  server_tokens off;

  map $upstream_response_time $urt {
    default               $upstream_response_time;
    "-"                   "0.000";
    ""                    "0.000";
  }

  map $http_user_agent $ua {
    default               $http_user_agent;
    "-"                   "unknown";
    ""                    "unknown";
  }

  map $http_X_Akamai_Edgescape $esc {
    default               $http_X_Akamai_Edgescape;
    "-"                   "none";
    ""                    "none";
  }

  map $http_X_Akamai_Edgescape $country {
    default               "us";
    "~country_code=([A-Z]{2})"               "$1";
  }

  # a hack to have the global logz_token nginx var
  map $host $logz_token {
    default               <%= ENV["LOGZ_TOKEN"] %>;
  }

  log_format l2met 'measure#nginx.service=$request_time request_id="$http_x_request_id" path="$request_uri" upstream_response_time=$urt country="$country" edgescape="$esc" user_agent="$ua" status=$status method="$request_method" host="$host" timestamp="$time_iso8601" cache="$upstream_cache_status" bytes=$bytes_sent upstream_host="$proxy_host" referrer=$http_referer auth=$http_authorization';
  log_format syslog '{"measure#nginx.service":$request_time,"type":"rbtv-gsd","request_id":"$http_x_request_id","path":"$request_uri","upstream_response_time":$urt,"country":"$country","edgescape":"$esc","user_agent":"$ua","status":$status,"method":"$request_method","token":"$logz_token","@timestamp":"$time_iso8601","host":"$host","cache_status":"$upstream_cache_status","bytes":$bytes_sent,"upstream_host":"$proxy_host","referer":"$http_referer"}';
  access_log logs/nginx/access.log l2met;
  access_log syslog:server=listener.logz.io:5050 syslog;
  error_log logs/nginx/error.log;

  include mime.types;
  default_type application/octet-stream;
  sendfile on;

  proxy_cache_path /app/cache keys_zone=cache:10m levels=1:2 inactive=600s max_size=100m;


  # Default server
  server {
    listen 80 default_server;
    server_name  _; # some invalid name that won't match anything
    return 444;
  }
  # Other servers
  include /etc/nginx/config/*.conf;
}
